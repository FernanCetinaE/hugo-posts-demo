{{- define "title" }}{{ .Title }} | {{ .Site.Title }}{{ end -}}
{{- define "extra_link" }}
  {{ $image_preview_styles := resources.Get "/css/image-preview.css" }}
  {{ $image_preview_styles = $image_preview_styles | resources.PostCSS (dict "inlineImports" true) }}
  {{ if hugo.IsProduction }}
    {{ $image_preview_styles = $image_preview_styles | minify | fingerprint | resources.PostProcess }}
  {{ end }}
  <link href="{{ $image_preview_styles.RelPermalink }}" rel="stylesheet" />

  {{ if .Site.Params.enableHighlight }}
    {{ $syntax := resources.Get "/css/syntax.css" }}
    {{ $syntax = $syntax | resources.PostCSS (dict "inlineImports" true) }}
    {{ if hugo.IsProduction }}
      {{ $syntax = $syntax | minify | fingerprint | resources.PostProcess }}
    {{ end }}
    <link href="{{ $syntax.RelPermalink }}" rel="stylesheet" />
  {{ end }}

{{- end -}}
{{ define "main" }}
  {{ $metaInfo := .Site.Params.articleMeta }}

  {{/* Image */}}
  {{ if not $metaInfo.disableHero }}
    {{ $image := resources.Get .Params.image }}
    {{ with $image }}
      <div id="post-feature" class="mt-38 w-full">
        <img
          class="h-60 w-full object-cover md:h-120"
          src="{{ $image.Permalink }}"
          alt="preview image"
          srcset="" />
      </div>
    {{ else }}
      <div id="post-feature" class="mt-38 h-60 w-full md:h-120">
        {{- partial "random_feature_img.html" . -}}
      </div>
    {{ end }}
  {{ else }}
    <div id="post-feature" class="mt-38"></div>
  {{ end }}


  <div id="single-page-container" class="my-5 w-full rounded-b-lg px-5">
    <div class="mx-auto flex max-w-screen-xl">
      {{/* Left side */}}
      {{ partial "content_left_section.html" . }}
      {{/* Content */}}
      <div id="post-container" class="mx-auto w-full md:max-w-3xl lg:w-2/3">
        {{/* Title */}}
        <div
          id="post-title"
          data-popover-target="popover-animation"
          data-popover-offset="0"
          data-popover-placement="bottom"
          class="flex w-full flex-col py-5 md:px-1 lg:px-7">
          <div
            class="flex flex-row flex-wrap space-x-1 pb-2 pl-2 pt-1 font-Oswald text-sm font-normal tracking-wide text-gray-500/90 dark:text-gray-500">
            {{ $categories := (.GetTerms "categories") }}
            <span class="flex flex-row gap-1">
              {{ range $categories }}
                <span class="italic text-red-700"> > </span>
                <a
                  class="border-b-2 border-transparent hover:border-b-2 hover:border-blue-600 hover:text-blue-600"
                  href="{{ .Permalink }}"
                  >{{- .LinkTitle -}}</a
                >
              {{ end }}
            </span>
          </div>
          <div
            class="py-1 pl-2 text-start text-3xl font-bold tracking-wide text-black lg:text-4xl dark:text-white">
            {{ .Title }}
          </div>

          <div
            class="flex flex-row flex-wrap items-center space-x-1 pb-1 pl-2 pt-3.5 font-serif text-xs font-extralight tracking-wide text-gray-500/90 dark:text-gray-600">
            <span>{{ .Date.Format "2006/01/02" }}</span>
            <div
              class="h-1 w-1 rounded-full bg-red-700 dark:bg-red-700/50"></div>
            <span>{{- .WordCount | printf "%d words" -}}</span>
            <div
              class="h-1 w-1 rounded-full bg-red-700 dark:bg-red-700/50"></div>
            <span>{{- .ReadingTime| printf "%d minutes read" -}}</span>
            {{ if .Site.Params.articleMeta.enablePageView }}
              <div
                class="h-1 w-1 rounded-full bg-red-700 dark:bg-red-700/50"></div>
              <p>
                <span
                  id="twikoo_visitors"
                  class="page-info-pageview-count"
                  data-path="{{ .RelPermalink }}"
                  >...</span
                >
                visits
              </p>
            {{ end }}
          </div>
        </div>

        {{/* Content */}}
        <div
          id="single-content"
          class="format mx-auto max-w-none px-1 py-5 md:format-base dark:format-invert format-figure:flex format-figure:flex-col format-figure:items-center format-img:cursor-zoom-in md:px-3 lg:px-10 dark:text-gray-300">
          {{ .Content }}
        </div>

        {{/* tags */}}
        <div class="px-1 pb-5 pt-1  md:px-3 lg:px-10">
          {{ $tags := (.GetTerms "tags") }}
          <span
            class="flex flex-row flex-wrap justify-start gap-2 pl-1 font-serif text-sm font-normal tracking-wide text-gray-500/90 dark:text-gray-500">
            {{ range $tags }}
              <a class="text-center hover:text-blue-600" href="{{ .Permalink }}"
                ><span class="text-red-700 ">#</span
                ><span
                  class="border-b-2 border-transparent hover:border-b-2 hover:border-blue-600"
                  >{{- .LinkTitle -}}</span
                ></a
              >
            {{ end }}
          </span>
        </div>
      </div>
      {{/* Right side */}}
      {{ partial "content_right_section.html" . }}
    </div>

    {{/* comments */}}
    {{ if and (not .Params.disableComment) .Site.Params.comment.enable }}
      <div id="post-comment">{{- partial "comments.html" . -}}</div>
    {{ end }}

    {{- partial "speed_dial.html" . -}}

    {{ if .Site.Params.enableToTop }}
      {{- partial "to_top.html" . -}}
    {{ end }}

  </div>
{{ end }}

{{ define "script" }}
  {{ if not .Site.Params.articleMeta.disableToc }}
    {{ $tocJS := resources.Get "/js/toc.js" }}
    {{ if hugo.IsProduction }}
      {{ $tocJS = $tocJS | minify | fingerprint }}
    {{ end }}
    <script src="{{ $tocJS.RelPermalink }}"></script>
  {{ end }}

  {{ if and .Site.Params.waline.serverURL .Site.Params.waline.alonePageview }}
    <script src="https://unpkg.com/@waline/client@v2/dist/pageview.js"></script>
    {{ $serverURL := .Site.Params.waline.serverURL }}
    {{ $walineInfo := dict "serverURL" $serverURL }}
    {{ $walinePageViewJS := resources.Get "/js/waline-pageview.js" | js.Build (dict "params" $walineInfo) }}
    {{ if hugo.IsProduction }}
      {{ $walinePageViewJS = $walinePageViewJS | minify | fingerprint }}
    {{ end }}
    <script src="{{ $walinePageViewJS.RelPermalink }}" defer></script>
  {{ end }}

  {{ $zoomJS := resources.Get "/js/zoom-img.js" }}
  {{ if hugo.IsProduction }}
    {{ $zoomJS = $zoomJS| minify | fingerprint }}
  {{ end }}
  <script src="{{ $zoomJS.RelPermalink }}" defer></script>

  {{ $linkTopJS := resources.Get "/js/link-to-top.js" }}
  {{ if hugo.IsProduction }}
    {{ $linkTopJS = $linkTopJS | minify | fingerprint }}
  {{ end }}
  <script src="{{ $linkTopJS.RelPermalink }}" defer></script>

  {{ if .Site.Params.showCodeCopyButton }}
    {{ $codeCopyJS := resources.Get "/js/code-copy.js" }}
    {{ if hugo.IsProduction }}
      {{ $codeCopyJS = $codeCopyJS | minify | fingerprint }}
    {{ end }}
    <script src="{{ $codeCopyJS.RelPermalink }}" defer></script>
  {{ end }}


  <script>
    console.log("aaaaaaa helo");
    document.addEventListener("alpine:init", () => {
      Alpine.data("toc", () => ({
        links: document.querySelectorAll("#single-toc a"),
        activeIndex: null,
        count: 0,
        init() {
          this.count = this.links.length;
          this.findActiveLink();
          console.log("activeIndex:", this.activeIndex, "count:", this.count);
        },
        findActiveLink() {
          this.links.forEach((link, index) => {
            if (link.classList.contains("theme-toc-active")) {
              this.activeIndex = index + 1; // 1-based index
            }
          });
        },
      }));
    });

    var testA = "abcdecdev";
    function testABC() {
      console.log(testA);
    }

    var observerTest = new MutationObserver(function (mutationsList, observer) {
      for (var mutation of mutationsList) {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "class"
        ) {
          console.log("class属性已改变!");
          console.log(mutation);
        }
      }
    });

    allTocEles = document.querySelectorAll("#single-toc a");
    allTocEles.forEach((ele) => {
      observerTest.observe(ele, {
        characterData: true,
        attributeOldValue: true,
        attributeFilter: ["class"],
      });
    });
  </script>
{{ end }}
